import{r as p,a as u}from"./index-d4351645.js";const f="acc_project_data_cache";class C{constructor(){this.data=p({currentProject:null,fileData:{},userData:{},permissionData:{},unifiedStats:{},loading:{fileData:!1,userData:!1,permissionData:!1},cacheTimestamps:{},dataVersion:0,downloadUrlCache:{}}),this.cacheExpireTime=30*60*1e3,this.activeRequests=new Map,this.asyncControllers=new Map,this.loadFromCache()}cancelAllAsyncOperations(){console.log("ğŸš« cancelæ‰€æœ‰å¼‚æ­¥æ“ä½œ...");for(const[a,t]of this.asyncControllers.entries())console.log("ğŸš« cancelå¼‚æ­¥æ“ä½œ:",a),t.abort();this.asyncControllers.clear();for(const[a,t]of this.activeRequests.entries())console.log("ğŸš« æ ‡è®°è¯·æ±‚ä¸ºcancel:",a);this.activeRequests.clear(),console.log("âœ… æ‰€æœ‰å¼‚æ­¥æ“ä½œå·²cancel")}setCurrentProject(a){a&&(console.log("ğŸ¯ è®¾ç½®å½“å‰é¡¹ç›®:",a.name),this.data.currentProject=a,(this.data.fileData[a.id]||this.data.userData[a.id])&&console.log("ğŸ”„ é¡¹ç›®åˆ‡æ¢ï¼Œæ£€æŸ¥ç¼“å­˜æ•°æ®"),this.saveToCache())}getCurrentProject(){return this.data.currentProject}async getFileData(a,t=!1,e=5){return a?(t&&(console.log("ğŸ”„ å¼ºåˆ¶åˆ·æ–°ï¼šæ¸…é™¤æ–‡ä»¶æ•°æ®ç¼“å­˜"),delete this.data.fileData[a],delete this.data.cacheTimestamps[`fileData_${a}`]),!t&&this.isDataValid("fileData",a)?(console.log("ğŸ“ ä½¿ç”¨ç¼“å­˜çš„æ–‡ä»¶æ•°æ®"),this.data.fileData[a]):await this.loadFileData(a,e,t)):(console.error("âŒ é¡¹ç›®IDä¸ºç©º"),null)}async getUserData(a,t=!1){return a?!t&&this.isDataValid("userData",a)?(console.log("ğŸ‘¥ ä½¿ç”¨ç¼“å­˜çš„ç”¨æˆ·æ•°æ®"),this.data.userData[a]):await this.loadUserData(a):(console.error("âŒ é¡¹ç›®IDä¸ºç©º"),null)}async loadFileData(a,t=6,e=!1){const s=`fileData_${a}_${t}_${e}`;if(this.activeRequests.has(s))return console.log("â³ ç›¸åŒçš„æ–‡ä»¶æ•°æ®è¯·æ±‚æ­£åœ¨è¿›è¡Œä¸­ï¼Œç­‰å¾…ç»“æœ...",{projectId:a,maxDepth:t,forceRefresh:e}),await this.activeRequests.get(s);if(this.data.loading.fileData||this.data.loading[s])return console.log("â³ æ–‡ä»¶æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚...",{projectId:a,maxDepth:t,forceRefresh:e}),null;if(!e&&Object.keys(this.data.loading).some(n=>n.startsWith(`fileData_${a}`)&&this.data.loading[n]))return console.log("â³ æ£€æµ‹åˆ°åŒé¡¹ç›®çš„å…¶ä»–åŠ è½½ä»»åŠ¡ï¼Œè·³è¿‡é‡å¤è¯·æ±‚..."),null;if(!e&&this.data.fileData[a])return console.log("âœ¨ æ–‡ä»¶æ•°æ®å·²å­˜åœ¨ä¸”éå¼ºåˆ¶åˆ·æ–°ï¼Œè¿”å›ç¼“å­˜æ•°æ®"),this.data.fileData[a];let o;t>5?o=this._executeProgressiveFileDataRequest(a,t,e,s):o=this._executeFileDataRequest(a,t,e,s),this.activeRequests.set(s,o);try{return await o}finally{this.activeRequests.delete(s)}}async _executeProgressiveFileDataRequest(a,t,e,s){var o;try{console.log("ğŸ“ å¼€å§‹æ¸è¿›å¼åŠ è½½æ–‡ä»¶æ•°æ®:",{projectId:a,maxDepth:t,forceRefresh:e,requestKey:s}),this.data.loading.fileData=!0,this.data.loading[s]=!0,console.log("ğŸ”„ ç¬¬ä¸€é˜¶æ®µï¼šåŠ è½½åŸºç¡€æ–‡ä»¶ç»“æ„...");const l={maxDepth:5,includePermissions:!1,includeCustomAttributes:!1};e&&(l._t=Date.now());const n=await u.get(`/api/file-sync/project/${a}/tree-fast`,{timeout:3e4});let i=n.data;if(n.data.status==="success"&&n.data.data)return i=n.data.data,console.log("âœ… ç¬¬ä¸€é˜¶æ®µåŠ è½½å®Œæˆ:",{project_id:i.project_id,top_folders:((o=i.top_folders)==null?void 0:o.length)||0}),this.data.fileData[a]=i,this.data.cacheTimestamps[`fileData_${a}`]=Date.now(),this.saveToCache(),console.log("âœ… å¿«é€Ÿæ¨¡å¼å®Œæˆï¼Œè·³è¿‡ç¬¬äºŒé˜¶æ®µåŠ è½½"),i;throw new Error(n.data.error||"åŠ è½½æ–‡ä»¶æ•°æ®å¤±è´¥")}catch(l){return console.error("âŒ æ¸è¿›å¼åŠ è½½æ–‡ä»¶æ•°æ®å¤±è´¥:",l),console.log("ğŸ”„ å›é€€åˆ°æ ‡å‡†åŠ è½½æ¨¡å¼..."),this._executeFileDataRequest(a,Math.min(t,3),e,s)}finally{this.data.loading.fileData=!1,this.data.loading[s]=!1}}async _loadFullStructureAsync(a,t,e,s){var l;const o=new AbortController;this.asyncControllers.set(s,o);try{console.log("ğŸš€ å¼€å§‹å¼‚æ­¥åŠ è½½å®Œæ•´æ–‡ä»¶ç»“æ„...",{projectId:a,asyncKey:s});const n={maxDepth:t,includePermissions:!0,includeCustomAttributes:!0};e&&(n._t=Date.now());const i=await u.get(`/api/file-sync/project/${a}/tree-with-permissions`,{params:n,timeout:18e4,signal:o.signal});if(o.signal.aborted){console.log("ğŸš« å¼‚æ­¥åŠ è½½å·²è¢«cancel:",s);return}if(i.data.status==="success"&&i.data.data){const c=i.data.data;if(console.log("âœ… å®Œæ•´ç»“æ„åŠ è½½å®Œæˆ:",{project_id:c.project_id,top_folders:((l=c.top_folders)==null?void 0:l.length)||0,statistics:c.statistics,asyncKey:s}),o.signal.aborted){console.log("ğŸš« å¼‚æ­¥åŠ è½½åœ¨å¤„ç†å“åº”æ—¶è¢«cancel:",s);return}this.data.fileData[a]=c,this.data.cacheTimestamps[`fileData_${a}`]=Date.now(),this.updateUnifiedStats(a),this.saveToCache(),typeof window<"u"&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("fileDataUpdated",{detail:{projectId:a,fileData:c}}))}}catch(n){n.name==="AbortError"?console.log("ğŸš« å¼‚æ­¥åŠ è½½è¢«ç”¨æˆ·cancel:",s):console.warn("âš ï¸ å¼‚æ­¥åŠ è½½å®Œæ•´ç»“æ„å¤±è´¥:",n,{asyncKey:s})}finally{this.asyncControllers.delete(s)}}async _executeFileDataRequest(a,t,e,s){var o;try{console.log("ğŸ“ å¼€å§‹åŠ è½½æ–‡ä»¶æ•°æ®:",{projectId:a,maxDepth:t,forceRefresh:e,requestKey:s}),this.data.loading.fileData=!0,this.data.loading[s]=!0;const l={maxDepth:t,includePermissions:!1,includeCustomAttributes:!0};e&&(l._t=Date.now());const n=await u.get(`/api/file-sync/project/${a}/tree-fast`,{params:l,timeout:6e4});let i=n.data;return n.data.status==="success"&&n.data.data?(i=n.data.data,console.log("ğŸ“ æ–‡ä»¶æ•°æ®åŠ è½½æˆåŠŸ:",{project_id:i.project_id,top_folders:((o=i.top_folders)==null?void 0:o.length)||0,statistics:i.statistics}),this.clearLoadedMarks(i.top_folders),this.markLoadedNodes(i.top_folders,0,t)):console.warn("âš ï¸ æ–‡ä»¶æ•°æ®å“åº”æ ¼å¼å¼‚å¸¸:",n.data),this.data.fileData[a]=i,this.data.cacheTimestamps[`fileData_${a}`]=Date.now(),this.updateUnifiedStats(a),this.saveToCache(),console.log("âœ… æ–‡ä»¶æ•°æ®åŠ è½½æˆåŠŸ"),i}catch(l){throw console.error("âŒ åŠ è½½æ–‡ä»¶æ•°æ®å¤±è´¥:",l),l}finally{this.data.loading.fileData=!1,this.data.loading[s]=!1}}async loadUserData(a){if(this.data.loading.userData)return console.log("â³ ç”¨æˆ·æ•°æ®æ­£åœ¨åŠ è½½ä¸­..."),null;try{console.log("ğŸ‘¥ å¼€å§‹åŠ è½½ç”¨æˆ·æ•°æ®:",a),this.data.loading.userData=!0;const t=await u.get(`/api/users/project/${a}/users`,{params:{limit:200,offset:0,sort:"name"}});let e=t.data;return t.data.status==="success"&&t.data.data&&(e=t.data.data),this.data.userData[a]=e,this.data.cacheTimestamps[`userData_${a}`]=Date.now(),this.updateUnifiedStats(a),this.saveToCache(),console.log("âœ… ç”¨æˆ·æ•°æ®åŠ è½½æˆåŠŸ"),e}catch(t){throw console.error("âŒ åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:",t),t}finally{this.data.loading.userData=!1}}updateUnifiedStats(a){var o,l,n,i,c,h,r,d,m,g,_,w,D;const t=this.data.fileData[a],e=this.data.userData[a];if(!t&&!e)return;const s={project_id:a,last_updated:new Date().toISOString(),files:{total_folders:((o=t==null?void 0:t.statistics)==null?void 0:o.total_folders)||0,total_files:((l=t==null?void 0:t.statistics)==null?void 0:l.total_files)||0,total_size:((n=t==null?void 0:t.statistics)==null?void 0:n.total_size)||0},users:{total_project_users:((i=e==null?void 0:e.statistics)==null?void 0:i.total_users)||0,active_users:((c=e==null?void 0:e.statistics)==null?void 0:c.active_users)||0,pending_users:((h=e==null?void 0:e.statistics)==null?void 0:h.pending_users)||0,users_with_file_permissions:((r=t==null?void 0:t.permission_summary)==null?void 0:r.total_users)||0,users_without_file_permissions:Math.max(0,(((d=e==null?void 0:e.statistics)==null?void 0:d.total_users)||0)-(((m=t==null?void 0:t.permission_summary)==null?void 0:m.total_users)||0))},permissions:{total_roles:Math.max(((g=e==null?void 0:e.statistics)==null?void 0:g.roles)||0,((_=t==null?void 0:t.permission_summary)==null?void 0:_.total_roles)||0),total_companies:Math.max(((w=e==null?void 0:e.statistics)==null?void 0:w.companies)||0,((D=t==null?void 0:t.permission_summary)==null?void 0:D.total_companies)||0)},data_completeness:{has_file_data:!!t,has_user_data:!!e,is_complete:!!(t&&e)}};this.data.unifiedStats[a]=s,this.data.dataVersion++,console.log("ğŸ“Š ç»Ÿä¸€ç»Ÿè®¡æ•°æ®å·²æ›´æ–°:",s)}incrementStats(a,t){const e=this.data.fileData[a];!e||!e.statistics||(t.folders&&(e.statistics.total_folders+=t.folders),t.files&&(e.statistics.total_files+=t.files),t.totalSize&&(e.statistics.total_size+=t.totalSize),this.updateUnifiedStats(a),console.log("ğŸ“Š å¢é‡ç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ:",t))}clearLoadedMarks(a){if(!(!a||!Array.isArray(a)))for(const t of a)t.type==="folder"&&(delete t._childrenLoaded,t.children&&Array.isArray(t.children)&&this.clearLoadedMarks(t.children))}markLoadedNodes(a,t=0,e=6){if(!(!a||!Array.isArray(a))){for(const s of a)if(s.type==="folder"){const o=s.children&&Array.isArray(s.children);t<e-1?o&&s.children.length>0?(s._childrenLoaded=!0,this.markLoadedNodes(s.children,t+1,e)):s._childrenLoaded=!1:t===e-1&&o?(s._childrenLoaded=!0,s.children.length>0&&this.markLoadedNodes(s.children,t+1,e)):s._childrenLoaded=!1}}}getUnifiedStats(a){return this.data.unifiedStats[a]||null}isDataValid(a,t){const e=`${a}_${t}`,s=this.data.cacheTimestamps[e];if(!s)return!1;const l=Date.now()-s<this.cacheExpireTime;return l||console.log(`â° ${a} ç¼“å­˜å·²è¿‡æœŸ`),l&&!!this.data[a][t]}async refreshProjectData(a,t=6){console.log("ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡¹ç›®æ•°æ®:",a),this.clearProjectCache(a);const e=[this.loadFileData(a,t,!0),this.loadUserData(a)];try{const s=await Promise.allSettled(e),o=s[0],l=s[1];return o.status==="rejected"&&console.error("âŒ æ–‡ä»¶æ•°æ®åˆ·æ–°å¤±è´¥:",o.reason),l.status==="rejected"&&console.error("âŒ ç”¨æˆ·æ•°æ®åˆ·æ–°å¤±è´¥:",l.reason),console.log("âœ… é¡¹ç›®æ•°æ®åˆ·æ–°å®Œæˆ"),this.getUnifiedStats(a)}catch(s){throw console.error("âŒ é¡¹ç›®æ•°æ®åˆ·æ–°å¤±è´¥:",s),s}}clearProjectCache(a){console.log("ğŸ—‘ï¸ æ¸…é™¤é¡¹ç›®ç¼“å­˜:",a),delete this.data.fileData[a],delete this.data.userData[a],delete this.data.unifiedStats[a],delete this.data.downloadUrlCache[a],delete this.data.cacheTimestamps[`fileData_${a}`],delete this.data.cacheTimestamps[`userData_${a}`];for(const[t,e]of this.activeRequests.entries())t.includes(a)&&(this.activeRequests.delete(t),console.log("ğŸ—‘ï¸ æ¸…é™¤æ´»è·ƒè¯·æ±‚:",t));this.data.dataVersion++,this.saveToCache()}getLoadingState(){return{...this.data.loading}}saveToCache(){try{const a={currentProject:this.data.currentProject,fileData:this.data.fileData,userData:this.data.userData,unifiedStats:this.data.unifiedStats,downloadUrlCache:this.data.downloadUrlCache,cacheTimestamps:this.data.cacheTimestamps,dataVersion:this.data.dataVersion,saved_at:Date.now()};localStorage.setItem(f,JSON.stringify(a))}catch(a){console.error("âŒ ä¿å­˜ç¼“å­˜å¤±è´¥:",a)}}loadFromCache(){try{const a=localStorage.getItem(f);if(!a)return;const t=JSON.parse(a),e=Date.now();if(t.saved_at&&e-t.saved_at>24*60*60*1e3){console.log("â° æœ¬åœ°ç¼“å­˜å·²è¿‡æœŸï¼Œæ¸…é™¤ç¼“å­˜"),localStorage.removeItem(f);return}t.currentProject&&(this.data.currentProject=t.currentProject),t.fileData&&(this.data.fileData=t.fileData),t.userData&&(this.data.userData=t.userData),t.unifiedStats&&(this.data.unifiedStats=t.unifiedStats),t.downloadUrlCache&&(this.data.downloadUrlCache=t.downloadUrlCache),t.cacheTimestamps&&(this.data.cacheTimestamps=t.cacheTimestamps),t.dataVersion&&(this.data.dataVersion=t.dataVersion),console.log("ğŸ“¦ ä»æœ¬åœ°ç¼“å­˜æ¢å¤æ•°æ®")}catch(a){console.error("âŒ åŠ è½½ç¼“å­˜å¤±è´¥:",a)}}clearAllCache(){console.log("ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼“å­˜"),this.data.currentProject=null,this.data.fileData={},this.data.userData={},this.data.unifiedStats={},this.data.downloadUrlCache={},this.data.cacheTimestamps={},this.data.dataVersion=0,localStorage.removeItem(f)}getCacheStatus(){var o,l;const a=this.data.currentProject;if(!a)return null;const t=a.id,e=this.isDataValid("fileData",t),s=this.isDataValid("userData",t);return{project:a,cache_status:{file_data:{exists:!!this.data.fileData[t],valid:e,timestamp:this.data.cacheTimestamps[`fileData_${t}`]},user_data:{exists:!!this.data.userData[t],valid:s,timestamp:this.data.cacheTimestamps[`userData_${t}`]},unified_stats:{exists:!!this.data.unifiedStats[t],complete:((l=(o=this.data.unifiedStats[t])==null?void 0:o.data_completeness)==null?void 0:l.is_complete)||!1}},data_version:this.data.dataVersion}}async preloadDownloadUrls(a,t){if(!a||!t)return;console.log("ğŸ”— å¼€å§‹é¢„ç¼“å­˜ä¸‹è½½URL...");const e=this.collectAllFiles(t.top_folders||[]);if(e.length===0){console.log("ğŸ“ æ²¡æœ‰æ‰¾åˆ°å¯ä¸‹è½½çš„æ–‡ä»¶");return}console.log(`ğŸ“ æ‰¾åˆ° ${e.length} ä¸ªæ–‡ä»¶ï¼Œå¼€å§‹æ‰¹é‡è·å–ä¸‹è½½URL...`),this.data.downloadUrlCache[a]||(this.data.downloadUrlCache[a]={});const s=10,o=[];for(let i=0;i<e.length;i+=s)o.push(e.slice(i,i+s));let l=0,n=0;for(let i=0;i<o.length;i++){const c=o[i];console.log(`ğŸ”„ å¤„ç†ç¬¬ ${i+1}/${o.length} æ‰¹æ–‡ä»¶ (${c.length} ä¸ªæ–‡ä»¶)`);const h=c.map(async r=>{try{const d=await u.get(`/api/file-sync/download/${a}/${r.id}`,{timeout:3e4});if(d.data.status==="success")return this.data.downloadUrlCache[a][r.id]={downloadInfo:d.data.download_info,versionInfo:d.data.version_info,message:d.data.message,cachedAt:Date.now(),fileName:r.name},l++,{success:!0,fileId:r.id,fileName:r.name};throw new Error(d.data.error||"è·å–ä¸‹è½½ä¿¡æ¯å¤±è´¥")}catch(d){return n++,console.warn(`âš ï¸ è·å–æ–‡ä»¶ "${r.name}" ä¸‹è½½URLå¤±è´¥:`,d.message),{success:!1,fileId:r.id,fileName:r.name,error:d.message}}});await Promise.all(h),i<o.length-1&&await new Promise(r=>setTimeout(r,500))}return console.log(`âœ… ä¸‹è½½URLé¢„ç¼“å­˜å®Œæˆ: æˆåŠŸ ${l} ä¸ªï¼Œå¤±è´¥ ${n} ä¸ª`),this.saveToCache(),{total:e.length,success:l,error:n}}collectAllFiles(a){const t=[],e=s=>{var o,l,n;if(!(!s||!Array.isArray(s)))for(const i of s)if(i.type==="file"){const c=((n=(l=(o=i.attributes)==null?void 0:o.extension)==null?void 0:l.data)==null?void 0:n.sourceFileName)||i.name||"",h=this.getFileExtension(c).toLowerCase();new Set(["pdf","doc","docx","xls","xlsx","ppt","pptx","dwg","dxf","rvt","rfa","ifc","jpg","jpeg","png","gif","bmp","tiff","zip","rar","7z","txt","csv","md","mp4","avi","mov","wmv","flv","mp3","wav","aac","flac","3dm","step","stp","iges","igs","obj","fbx","max","skp"]).has(h)&&t.push({id:i.id,name:i.name,extension:h})}else i.type==="folder"&&i.children&&e(i.children)};return e(a),t}getFileExtension(a){if(!a)return"unknown";const t=a.split(".").pop();return t?t.toUpperCase():"unknown"}getCachedDownloadUrl(a,t){if(!a||!t)return null;const e=this.data.downloadUrlCache[a];if(!e||!e[t])return null;const s=e[t],o=Date.now()-s.cachedAt,l=60*60*1e3;return o>l?(console.log(`â° ä¸‹è½½URLç¼“å­˜å·²è¿‡æœŸ: ${s.fileName}`),delete e[t],null):s}clearDownloadUrlCache(a){a?delete this.data.downloadUrlCache[a]:this.data.downloadUrlCache={},console.log("ğŸ—‘ï¸ å·²æ¸…é™¤ä¸‹è½½URLç¼“å­˜:",a||"å…¨éƒ¨")}}const v=new C,{setCurrentProject:S,getCurrentProject:P,getFileData:A,getUserData:$,getUnifiedStats:T,refreshProjectData:x,clearProjectCache:L,clearAllCache:b,getCacheStatus:F,getLoadingState:V,preloadDownloadUrls:E,getCachedDownloadUrl:k,clearDownloadUrlCache:R}=v;export{b as clearAllCache,R as clearDownloadUrlCache,L as clearProjectCache,v as default,F as getCacheStatus,k as getCachedDownloadUrl,P as getCurrentProject,A as getFileData,V as getLoadingState,T as getUnifiedStats,$ as getUserData,E as preloadDownloadUrls,x as refreshProjectData,S as setCurrentProject};
